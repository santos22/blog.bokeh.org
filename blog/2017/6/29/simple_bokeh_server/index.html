<!doctype html>
<meta charset="utf-8">
<head>

<link rel="stylesheet" href="../../../../../static/normalize.css">
<link rel="stylesheet" href="../../../../../static/skeleton.css">
<link rel="stylesheet" href="../../../../../static/style.css">
<link rel="stylesheet" href="../../../../../static/gen/styles.css">
<link rel="stylesheet" href="../../../../../static/custom.css">
<link rel="stylesheet" href="../../../../../static/pygments.css">

<!-- Mobile Specific Metas
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FONT
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

<title>Programmatic Bokeh Servers | Bokeh Org</title>

</head>
<body>
    <div class="navbar-spacer"></div>
    <nav class="navbar">
      <div class="container">
        <ul class="navbar-list">
            <li class="navbar-item"><a class="navbar-link" href="/">Home</a></li>
            <li class="navbar-item"><a class="navbar-link" href="https://bokeh.pydata.org/en/latest">Documentation</a></li>
            <li class="navbar-item"><a class="navbar-link" href="/blog">Blog</a></li>
        </ul>
      </div>
    </nav>

    <div class="body-wrapper">
      
  <div class="blog-post">
    
  
    
  <div class="container">
    <div class="row">
      <div class="eleven columns">
        
      <div class="meta-bar">
        <h1>Programmatic Bokeh Servers</h1>
        <p class="meta">
          by
          
            <a href="https://twitter.com/mrocklin">Matthew Rocklin</a>
          
          on Thursday, June 29, 2017
        </p>
      </div>
    
      </div>
    </div>
  </div>

  
  
    
      
  <div class="container">
    <div class="row">
      <div class="eleven columns">
        <div class="text-block text-block-default">
  <p><em>This work is supported by <a href="http://anaconda.com">Anaconda, Inc.</a></em></p>
<p>This blogpost shows how to start a <em>very simple</em> bokeh server application
<em>programmatically</em>.  For more complex examples, or for the more standard
command line interface, see the <a href="https://bokeh.pydata.org/en/latest/docs/user_guide/server.html">Bokeh
documentation</a>.</p>
<h2>Motivation</h2>
<p>Many people know Bokeh as a tool for building web visualizations from languages
like Python.  However I find that Bokeh's true value is in serving
live-streaming, interactive visualizations that update with real-time data.  I
personally use Bokeh to serve <a href="http://distributed.readthedocs.io/en/latest/web.html">real-time diagnostics for a distributed computing
system</a>.  In this case I
embed Bokeh directly into my library.  I've found it incredibly useful and easy
to deploy sophisticated and beautiful visualizations that help me understand
the deep inner-workings of my system.</p>
<p><br></p>
<p><div class="image"><center><img src="daskboard.gif" width="70%"></center></div>
<br></p>
<p>Most of the (excellent) documentation focuses on stand-alone applications using
the Bokeh server:</p>
<div class="highlight"><pre><span></span>$ bokeh serve myapp.py
</pre></div>
<p>However as a developer who wants to integrate Bokeh into my application
starting up a separate process from the command line doesn't work for me. Also,
I find that starting things from Python tends to be a bit simpler on my brain.
I thought I'd provide some examples on how to do this within a Jupyter
notebook.</p>
<h2>Launch Bokeh Servers from a Notebook</h2>
<p>The code below starts a Bokeh server running on port 5000 that provides a
single route to <code>/</code> that serves a single figure with a line-plot.  The imports
are a bit wonky, but the amount of code necessary here is relatively small.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bokeh.server.server</span> <span class="kn">import</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">bokeh.application</span> <span class="kn">import</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">bokeh.application.handlers.function</span> <span class="kn">import</span> <span class="n">FunctionHandler</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">ColumnDataSource</span>

<span class="k">def</span> <span class="nf">make_document</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Line plot!&#39;</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Hello, world!&quot;</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">add_root</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="n">apps</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">Application</span><span class="p">(</span><span class="n">FunctionHandler</span><span class="p">(</span><span class="n">make_document</span><span class="p">))}</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
<p><br></p>
<p><div class="image"><center><img src="bokeh-server-line-plot.png" width="40%"></center></div>
<br></p>
<p>We make a function <code>make_document</code> which is called every time someone visits
our website.  This function can create plots, call functions, and generally do
whatever it wants.  Here we make a simple line plot and register that plot with
the document with the <code>doc.add_root(...)</code> method.</p>
<p>This starts a Tornado web server and creates a new image whenever someone
connects, similar to libraries like Tornado, or Flask.  In this case our web
server piggybacks on the Jupyter notebook's own IOLoop.  Because Bokeh is built
on Tornado it can play nicely with other async applications like Tornado or
Asyncio.</p>
<h2>Live Updates</h2>
<p>I find that Bokeh's real strength comes when you want to stream live data into
the browser.  Doing this by hand generally means serializing your data on the
server, figuring out how web sockets work, sending the data to the
client/browser and then updating plots in the browser.</p>
<p>Bokeh handles this by keeping a synchronized table of data on the client and
the server, the <code>ColumnDataSource</code>.  If you define plots around the column data
source and then push more data into the source then Bokeh will handle the rest.
Updating your plots in the browser just requires pushing more data into the
column data source on the server.</p>
<p>In the example below every time someone connects to our server we make a new
<code>ColumnDataSource</code>, make an update function that adds a new record into it,
and set up a callback to call that function every 100ms.  We then make a plot
around that data source to render the data as colored circles.</p>
<p>Because this is a new Bokeh server we start this on a new port, though in
practice if we had multiple pages we would just add them as multiple routes in
the <code>apps</code> variable.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">make_document</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="p">[]})</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">():</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()],</span>
               <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()],</span>
               <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])]}</span>
        <span class="n">source</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">add_periodic_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Streaming Circle Plot!&#39;</span><span class="p">,</span> <span class="n">sizing_mode</span><span class="o">=</span><span class="s1">&#39;scale_width&#39;</span><span class="p">,</span>
                 <span class="n">x_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Now with live updating!&quot;</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">add_root</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="n">apps</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">Application</span><span class="p">(</span><span class="n">FunctionHandler</span><span class="p">(</span><span class="n">make_document</span><span class="p">))}</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5001</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
<p><br></p>
<p><div class="image"><center><img src="bokeh-server-circle-plot.gif" width="40%"></center></div>
<br></p>
<p>By changing around the figures (or combining multiple figures, text, other
visual elements, and so on) you have full freedom over the visual styling of your
web service.  By changing around the update function you can pull data from
sensors, shove in more interesting data, and so on.  This toy example is meant to
provide the skeleton of a simple application; hopefully you can fill in details
from your application.</p>
<h2>Real example</h2>
<p>Here is a simple example taken from Dask's dashboard that maintains a streaming
time series plot with the number of idle and saturated workers in a Dask
cluster.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_document</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">({</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">time</span><span class="p">(),</span> <span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                               <span class="s1">&#39;idle&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                               <span class="s1">&#39;saturated&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]})</span>

    <span class="n">x_range</span> <span class="o">=</span> <span class="n">DataRange1d</span><span class="p">(</span><span class="n">follow</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="n">follow_interval</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">range_padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Idle and Saturated Workers Over Time&quot;</span><span class="p">,</span>
                 <span class="n">x_axis_type</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">],</span>
                 <span class="n">height</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;idle&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;saturated&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">minor_tick_line_color</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span>
        <span class="n">ResetTool</span><span class="p">(</span><span class="n">reset_size</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">PanTool</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="s2">&quot;width&quot;</span><span class="p">),</span>
        <span class="n">WheelZoomTool</span><span class="p">(</span><span class="n">dimensions</span><span class="o">=</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">add_root</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">],</span>
                  <span class="s1">&#39;idle&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">idle</span><span class="p">)],</span>
                  <span class="s1">&#39;saturated&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">scheduler</span><span class="o">.</span><span class="n">saturated</span><span class="p">)]}</span>
        <span class="n">source</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">add_periodic_callback</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
<p>You can also have buttons, sliders, widgets, and so on.  I rarely use these
personally though so they don't interest me as much.</p>
<h2>Final Thoughts</h2>
<p>I've found the Bokeh server to be incredibly helpful in my work and also very
approachable once you understand how to set one up (as you now do). I hope
that this post serves people well. This blogpost is available as a <a href="https://gist.github.com/e014f11aab7eb3fd12d83a746d8c87df">Jupyter
notebook</a> if you want
to try it out yourself.</p>

</div>
      </div>
    </div>
  </div>

    
  


    
    
    
    <div class="container">
      <div class="row">
        <div class="eight columns">
        
          <div class="nav-prev">
            <a href="../../../../../blog/2017/6/13/release-0-12-6/">Previous: Bokeh 0.12.6 Released</a>
          </div>
        
        
          <div class="nav-next">
            <a href="../../../../../blog/2017/7/5/idiomatic_bokeh/">Next: Enjoying the bokeh.models API</a>
          </div>
        
        </div>
      </div>
    </div>
  </div>

    </div>

    
    <div class="bottomsummary">
      <div class="container">
      </div>
    </div>
    

    
    <footer>
      <div class="container">
        <div class="row">
          <div class="four columns icon-bar">
            <a href="https://github.com/bokeh/bokeh/" title="Bokeh on GitHub"
              ><i class="fa fa-github"></i></a>
            <a href="https://github.com/bokeh/bokeh/issues/" title="Report Issues for Bokeh"
              ><i class="fa fa-bug"></i></a>
            <a href="https://twitter.com/BokehPlots" title="Find Bokeh on Twitter"
              ><i class="fa fa-twitter"></i></a>
            <a href="https://gitter.im/bokeh/bokeh" title="Chat on Gitter"
              ><i class="fa fa-comment"></i></a>
            <a href="https://github.com/bokeh/bokeh.github.io/tree/source/content/blog/simple_bokeh_server/contents.lr" title="View source for this page"><i class="fa fa-code"></i></a>
          </div>
        </div>
      </div>
    </footer>
    

<!-- JS
================================================== -->
<script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27761864-7', 'pydata.org');
  ga('user.set', 'anonymizeIp', true);
  ga('send', 'pageview');
</script>

</body>
